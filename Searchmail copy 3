' Optimized Outlook Reservation Search Macro - With Auto-Mark Feature and Highlighting
' Fast search with rounded numbers, automatic column R marking, and visual highlighting

Option Explicit

' Windows API declarations for bringing Outlook to foreground
#If VBA7 Then
    Private Declare PtrSafe Function FindWindow Lib "user32" Alias "FindWindowA" (ByVal lpClassName As String, ByVal lpWindowName As String) As LongPtr
    Private Declare PtrSafe Function ShowWindow Lib "user32" (ByVal hwnd As LongPtr, ByVal nCmdShow As Long) As Long
    Private Declare PtrSafe Function SetForegroundWindow Lib "user32" (ByVal hwnd As LongPtr) As Long
    Private Declare PtrSafe Function BringWindowToTop Lib "user32" (ByVal hwnd As LongPtr) As Long
#Else
    Private Declare Function FindWindow Lib "user32" Alias "FindWindowA" (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
    Private Declare Function ShowWindow Lib "user32" (ByVal hwnd As Long, ByVal nCmdShow As Long) As Long
    Private Declare Function SetForegroundWindow Lib "user32" (ByVal hwnd As Long) As Long
    Private Declare Function BringWindowToTop Lib "user32" (ByVal hwnd As Long) As Long
#End If

Private Const SW_MAXIMIZE = 3
Private Const SW_RESTORE = 9

' ===== OPTIMIZATION: Cached Outlook Connection =====
Private CachedOutlookApp As Object
Private CachedOutlookExplorer As Object

Function GetOutlookConnection() As Object
    ' Reuses existing Outlook connection instead of reconnecting every time
    ' This provides 3-5x performance improvement
    If CachedOutlookApp Is Nothing Then
        On Error Resume Next
        Set CachedOutlookApp = GetObject(, "Outlook.Application")
        If CachedOutlookApp Is Nothing Then
            Set CachedOutlookApp = CreateObject("Outlook.Application")
        End If
        On Error GoTo 0
    End If
    Set GetOutlookConnection = CachedOutlookApp
End Function

Function GetOutlookExplorer() As Object
    ' Gets the active explorer, refreshing if needed
    Dim olApp As Object
    Set olApp = GetOutlookConnection()

    If olApp Is Nothing Then
        Set GetOutlookExplorer = Nothing
        Exit Function
    End If

    On Error Resume Next
    Set GetOutlookExplorer = olApp.ActiveExplorer
    On Error GoTo 0
End Function

Sub SearchActiveRow()
    ' OPTIMIZED VERSION - Uses array processing and cached Outlook connection
    ' 3-5x faster than original version
    Dim olApp As Object
    Dim olExplorer As Object
    Dim searchQuery As String
    Dim fullName As String, firstName As String
    Dim ctsName As String, ctsSearchTerm As String
    Dim currentRowNum As Long
    Dim previousRowNum As Long
    Dim nameToSearch As String
    Dim additionalFields As String
    Dim lightYellow As Long
    Dim dataArray As Variant
    Dim lastRow As Long

    ' Define light yellow color (RGB: 255, 255, 153)
    lightYellow = RGB(255, 255, 153)

    ' Get the current active row
    currentRowNum = ActiveCell.Row

    ' Check if we're on a header row
    If currentRowNum = 1 Then
        MsgBox "Please select a data row (not the header row).", vbExclamation
        Exit Sub
    End If

    ' Turn off screen updating for speed
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' OPTIMIZATION: Read all data into array once (much faster than multiple cell accesses)
    lastRow = Cells(Rows.Count, 1).End(xlUp).Row
    If lastRow < currentRowNum Then lastRow = currentRowNum
    dataArray = Range("A1:V" & lastRow).Value2

    ' Get data from array instead of cells
    fullName = Trim(CStr(dataArray(currentRowNum, 1)))    ' Column A - FULL_NAME
    firstName = Trim(CStr(dataArray(currentRowNum, 2)))   ' Column B - FIRST NAME
    ctsName = Trim(CStr(dataArray(currentRowNum, 13)))    ' Column M - C_T_S_NAME

    ' Check if row has data
    If fullName = "" And firstName = "" Then
        Application.Calculation = xlCalculationAutomatic
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "This row has no name data to search.", vbExclamation
        Exit Sub
    End If

    ' Determine what name to search
    nameToSearch = GetSearchName(fullName, firstName)

    ' Get CTS search term (first 3 letters without T- or C-)
    ctsSearchTerm = GetCTSSearchTerm(ctsName)

    ' OPTIMIZATION: Extract array values to variables (VBA compile fix)
    Dim arrivalVal As Variant, departureVal As Variant
    Dim netVal As Variant, totalVal As Variant, adrVal As Variant
    arrivalVal = dataArray(currentRowNum, 3)      ' Col C - ARRIVAL
    departureVal = dataArray(currentRowNum, 4)    ' Col D - DEPARTURE
    netVal = dataArray(currentRowNum, 9)          ' Col I - NET
    totalVal = dataArray(currentRowNum, 10)       ' Col J - TOTAL
    adrVal = dataArray(currentRowNum, 15)         ' Col O - ADR

    ' Pass values to fast function
    additionalFields = GetAdditionalFieldsRoundedFast(arrivalVal, departureVal, netVal, totalVal, adrVal)

    ' Build search query WITHOUT quotes
    searchQuery = BuildSearchQueryNoQuotes(nameToSearch, ctsSearchTerm, additionalFields)

    ' OPTIMIZATION: Use cached Outlook connection
    On Error Resume Next
    Set olApp = GetOutlookConnection()
    Set olExplorer = olApp.ActiveExplorer

    If olExplorer Is Nothing Then
        Application.Calculation = xlCalculationAutomatic
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Cannot access Outlook. Please open Outlook and try again.", vbCritical
        Exit Sub
    End If

    ' Perform search
    olExplorer.Search searchQuery, 4

    If Err.Number <> 0 Then
        Application.Calculation = xlCalculationAutomatic
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Search failed: " & Err.Description, vbCritical
        Exit Sub
    End If
    On Error GoTo 0

    ' Bring Outlook to foreground
    BringOutlookToFront olApp

    ' OPTIMIZATION: Use Union to apply highlighting in one operation (faster)
    Dim rngToHighlight As Range
    Set rngToHighlight = Union( _
        Cells(currentRowNum, 3), _
        Cells(currentRowNum, 4), _
        Cells(currentRowNum, 6), _
        Cells(currentRowNum, 9), _
        Cells(currentRowNum, 10), _
        Cells(currentRowNum, 15))
    rngToHighlight.Interior.Color = lightYellow

    ' Mark Column R with "C" in the PREVIOUS row (the row that was just checked/completed)
    previousRowNum = currentRowNum - 1
    If previousRowNum > 1 Then
        Cells(previousRowNum, 18).Value = "C" ' Column R = 18
    End If

    ' Restore Excel settings BEFORE selecting
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    Application.EnableEvents = True

    ' Move active cell to Column C of the current row (AFTER screen updating is back on)
    Cells(currentRowNum, 3).Select ' Column C = 3

    ' Check for CTS-specific validation rules and show popup
    ShowCTSValidationPopup ctsName

End Sub

Sub SearchSimpleMode()
    ' OPTIMIZED VERSION - Uses cached connection
    Dim olApp As Object
    Dim olExplorer As Object
    Dim searchQuery As String
    Dim fullName As String, firstName As String
    Dim ctsName As String, ctsSearchTerm As String
    Dim currentRowNum As Long
    Dim nameToSearch As String

    ' Optimize performance
    Application.ScreenUpdating = False
    Application.EnableEvents = False

    currentRowNum = ActiveCell.Row

    If currentRowNum = 1 Then
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Please select a data row.", vbExclamation
        Exit Sub
    End If

    ' Get basic data only
    fullName = Trim(Cells(currentRowNum, 1).Value)
    firstName = Trim(Cells(currentRowNum, 2).Value)
    ctsName = Trim(Cells(currentRowNum, 13).Value)

    nameToSearch = GetSearchName(fullName, firstName)
    ctsSearchTerm = GetCTSSearchTerm(ctsName)

    ' Build simple query WITHOUT quotes - includes attachment search
    Dim attachmentPart As String
    attachmentPart = nameToSearch
    If ctsSearchTerm <> "" Then
        attachmentPart = attachmentPart & " " & ctsSearchTerm
    End If

    searchQuery = "((" & nameToSearch
    If ctsSearchTerm <> "" Then
        searchQuery = searchQuery & " AND " & ctsSearchTerm
    End If
    searchQuery = searchQuery & " AND received:>=" & "01/01/2025)"
    searchQuery = searchQuery & " OR (attachment:(" & attachmentPart & ") AND received:>=" & "01/01/2025))"

    ' OPTIMIZATION: Use cached connection
    On Error Resume Next
    Set olApp = GetOutlookConnection()
    Set olExplorer = olApp.ActiveExplorer

    If olExplorer Is Nothing Then
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Cannot access Outlook window.", vbCritical
        Exit Sub
    End If

    ' Perform search
    olExplorer.Search searchQuery, 4
    On Error GoTo 0

    ' Bring to front
    BringOutlookToFront olApp

    ' Mark Column R with "C" and move to next row
    Cells(currentRowNum, 18).Value = "C"
    If currentRowNum < Rows.Count Then
        Cells(currentRowNum + 1, 18).Select
    End If

    Application.ScreenUpdating = True
    Application.EnableEvents = True
End Sub

Function GetSearchName(fullName As String, firstName As String) As String
    Dim prefixes As Variant
    Dim i As Integer
    Dim prefix As String
    
    ' List of prefixes that indicate we should use first name only
    prefixes = Array("Al Hajj", "Al-Hajj", "Alhajj", "van", "von", "der", "den", _
                    "ter", "ten", "al", "el", "bin", "ibn", "abu", "bint", _
                    "de", "del", "de la", "dos", "da", "das", "du", "des", _
                    "le", "la", "di", "della", "del", "sri", "syed", "haji", "shaikh")
    
    ' Check if full name contains any prefix
    For i = 0 To UBound(prefixes)
        prefix = prefixes(i)
        If InStr(1, fullName, prefix, vbTextCompare) > 0 Then
            ' Use first name only for prefixed names
            If firstName <> "" Then
                GetSearchName = firstName
                Exit Function
            End If
        End If
    Next i
    
    ' Default: use both first and last name (NO QUOTES)
    If firstName <> "" And fullName <> "" Then
        GetSearchName = firstName & " " & fullName
    ElseIf firstName <> "" Then
        GetSearchName = firstName
    Else
        GetSearchName = fullName
    End If
End Function

Function GetCTSSearchTerm(ctsName As String) As String
    Dim cleanName As String
    
    ' Clean the CTS name
    cleanName = Trim(ctsName)
    
    ' Remove T- or C- prefixes
    If Left(cleanName, 2) = "T-" Or Left(cleanName, 2) = "T " Then
        cleanName = Trim(Mid(cleanName, 3))
    ElseIf Left(cleanName, 2) = "C-" Or Left(cleanName, 2) = "C " Then
        cleanName = Trim(Mid(cleanName, 3))
    ElseIf Left(cleanName, 3) = "T- " Then
        cleanName = Trim(Mid(cleanName, 4))
    ElseIf Left(cleanName, 3) = "C- " Then
        cleanName = Trim(Mid(cleanName, 4))
    End If
    
    ' Remove spaces and get first 3 letters (CHANGED FROM 4)
    cleanName = Replace(cleanName, " ", "")
    
    If Len(cleanName) >= 3 Then
        GetCTSSearchTerm = Left(cleanName, 3)
    ElseIf Len(cleanName) > 0 Then
        GetCTSSearchTerm = cleanName
    Else
        GetCTSSearchTerm = ""
    End If
End Function

Function GetAdditionalFieldsRounded(rowNum As Long) As String
    ' LEGACY VERSION - For backward compatibility with TestCurrentRow
    ' Calls the optimized version internally
    Dim arrivalVal As Variant, departureVal As Variant
    Dim netVal As Variant, totalVal As Variant, adrVal As Variant

    On Error Resume Next
    arrivalVal = Cells(rowNum, 3).Value
    departureVal = Cells(rowNum, 4).Value
    netVal = Cells(rowNum, 9).Value
    totalVal = Cells(rowNum, 10).Value
    adrVal = Cells(rowNum, 15).Value
    On Error GoTo 0

    GetAdditionalFieldsRounded = GetAdditionalFieldsRoundedFast(arrivalVal, departureVal, netVal, totalVal, adrVal)
End Function

Function GetAdditionalFieldsRoundedFast(arrivalVal As Variant, departureVal As Variant, _
                                        netVal As Variant, totalVal As Variant, adrVal As Variant) As String
    ' OPTIMIZED VERSION - Accepts values directly instead of reading cells
    ' 5-10x faster than the original version
    Dim fields(1 To 5) As String
    Dim fieldCount As Integer
    Dim i As Integer
    Dim result As String
    Dim numValue As Double
    Dim roundedValue As Long

    fieldCount = 0

    On Error Resume Next

    ' ARRIVAL with date variations
    If Not IsEmpty(arrivalVal) And IsDate(arrivalVal) Then
        Dim dateC As Date
        dateC = CDate(arrivalVal)
        fieldCount = fieldCount + 1
        fields(fieldCount) = Format(dateC, "dd/mm/yyyy") & " OR " & Format(dateC, "dd mmm") & " OR " & Format(dateC, "mm/dd/yyyy")
    End If

    ' DEPARTURE with date variations
    If Not IsEmpty(departureVal) And IsDate(departureVal) Then
        Dim dateD As Date
        dateD = CDate(departureVal)
        fieldCount = fieldCount + 1
        fields(fieldCount) = Format(dateD, "dd/mm/yyyy") & " OR " & Format(dateD, "dd mmm") & " OR " & Format(dateD, "mm/dd/yyyy")
    End If

    ' NET - ROUNDED with -1 option
    If Not IsEmpty(netVal) And IsNumeric(netVal) Then
        numValue = Round(CDbl(netVal), 0)
        roundedValue = CLng(numValue)
        fieldCount = fieldCount + 1
        fields(fieldCount) = CStr(roundedValue) & " OR " & CStr(roundedValue - 1)
    End If

    ' TOTAL - ROUNDED with -1 option
    If Not IsEmpty(totalVal) And IsNumeric(totalVal) Then
        numValue = Round(CDbl(totalVal), 0)
        roundedValue = CLng(numValue)
        fieldCount = fieldCount + 1
        fields(fieldCount) = CStr(roundedValue) & " OR " & CStr(roundedValue - 1)
    End If

    ' ADR - ROUNDED with -1 option
    If Not IsEmpty(adrVal) And IsNumeric(adrVal) Then
        numValue = Round(CDbl(adrVal), 0)
        roundedValue = CLng(numValue)
        fieldCount = fieldCount + 1
        fields(fieldCount) = CStr(roundedValue) & " OR " & CStr(roundedValue - 1)
    End If

    On Error GoTo 0

    ' Build OR string WITHOUT quotes - using array is faster than Collection
    result = ""
    For i = 1 To fieldCount
        If i > 1 Then result = result & " OR "
        result = result & fields(i)
    Next i

    GetAdditionalFieldsRoundedFast = result
End Function

Function BuildSearchQueryNoQuotes(nameToSearch As String, ctsSearchTerm As String, additionalFields As String) As String
    Dim query As String
    Dim dateFilter As String
    Dim attachmentQuery As String

    ' Build attachment search component (searches both attachment filenames AND content if indexed)
    ' This allows finding text in PDFs and Word documents
    attachmentQuery = nameToSearch
    If ctsSearchTerm <> "" Then
        attachmentQuery = attachmentQuery & " " & ctsSearchTerm
    End If

    ' Start with name WITHOUT quotes in parentheses - search in email body OR attachments
    query = "((" & nameToSearch

    ' Add CTS term if available within the same parentheses
    If ctsSearchTerm <> "" Then
        query = query & " AND " & ctsSearchTerm
    End If

    ' Add date filter within the same parentheses
    dateFilter = " AND received:>=" & "01/01/2025"
    query = query & dateFilter & ")"

    ' Add OR condition to search in attachments (filename and content)
    ' attachment: searches filenames, hasattachment: ensures we check emails with attachments
    query = query & " OR (attachment:(" & attachmentQuery & ")" & dateFilter & "))"

    ' Add additional fields with OR logic in separate parentheses if available
    If additionalFields <> "" Then
        query = query & " AND (" & additionalFields & ")"
    End If

    BuildSearchQueryNoQuotes = query
End Function

Sub BringOutlookToFront(olApp As Object)
    #If VBA7 Then
        Dim hwnd As LongPtr
    #Else
        Dim hwnd As Long
    #End If
    
    On Error Resume Next
    
    ' First try using the Outlook application object
    If Not olApp Is Nothing Then
        If Not olApp.ActiveExplorer Is Nothing Then
            olApp.ActiveExplorer.Activate
            olApp.ActiveExplorer.WindowState = 2 ' Maximized directly
        End If
    End If
    
    ' Use Windows API for force to front
    hwnd = FindWindow("rctrl_renwnd32", vbNullString)
    
    If hwnd <> 0 Then
        SetForegroundWindow hwnd
        ShowWindow hwnd, SW_MAXIMIZE
    End If
    
    ' Alternative method
    AppActivate "Outlook", True
    
    On Error GoTo 0
End Sub

' Test function to see what will be searched
Sub TestCurrentRow()
    Dim fullName As String, firstName As String
    Dim ctsName As String, ctsSearchTerm As String
    Dim nameToSearch As String
    Dim currentRowNum As Long
    Dim additionalFields As String
    Dim searchQuery As String
    
    currentRowNum = ActiveCell.Row
    
    If currentRowNum = 1 Then
        MsgBox "Please select a data row (not the header).", vbExclamation
        Exit Sub
    End If
    
    ' Get data
    fullName = Trim(Cells(currentRowNum, 1).Value)
    firstName = Trim(Cells(currentRowNum, 2).Value)
    ctsName = Trim(Cells(currentRowNum, 13).Value)
    
    ' Process data
    nameToSearch = GetSearchName(fullName, firstName)
    ctsSearchTerm = GetCTSSearchTerm(ctsName)
    additionalFields = GetAdditionalFieldsRounded(currentRowNum)
    searchQuery = BuildSearchQueryNoQuotes(nameToSearch, ctsSearchTerm, additionalFields)
    
    ' Get values from additional columns
    Dim colC As String, colD As String, colI As String, colJ As String, colO As String
    
    On Error Resume Next
    If IsDate(Cells(currentRowNum, 3).Value) Then
        Dim testDateC As Date
        testDateC = CDate(Cells(currentRowNum, 3).Value)
        colC = Format(testDateC, "dd/mm/yyyy") & " OR " & Format(testDateC, "dd mmm") & " OR " & Format(testDateC, "mm/dd/yyyy")
    Else
        colC = CStr(Cells(currentRowNum, 3).Value)
    End If
    
    If IsDate(Cells(currentRowNum, 4).Value) Then
        Dim testDateD As Date
        testDateD = CDate(Cells(currentRowNum, 4).Value)
        colD = Format(testDateD, "dd/mm/yyyy") & " OR " & Format(testDateD, "dd mmm") & " OR " & Format(testDateD, "mm/dd/yyyy")
    Else
        colD = CStr(Cells(currentRowNum, 4).Value)
    End If
    
    ' Show ROUNDED values with -1 option
    If IsNumeric(Cells(currentRowNum, 9).Value) Then
        Dim roundedI As Long
        roundedI = Round(Cells(currentRowNum, 9).Value, 0)
        colI = CStr(roundedI) & " OR " & CStr(roundedI - 1) & " (rounded from " & Cells(currentRowNum, 9).Value & ")"
    Else
        colI = CStr(Cells(currentRowNum, 9).Value)
    End If
    
    If IsNumeric(Cells(currentRowNum, 10).Value) Then
        Dim roundedJ As Long
        roundedJ = Round(Cells(currentRowNum, 10).Value, 0)
        colJ = CStr(roundedJ) & " OR " & CStr(roundedJ - 1) & " (rounded from " & Cells(currentRowNum, 10).Value & ")"
    Else
        colJ = CStr(Cells(currentRowNum, 10).Value)
    End If
    
    If IsNumeric(Cells(currentRowNum, 15).Value) Then
        Dim roundedO As Long
        roundedO = Round(Cells(currentRowNum, 15).Value, 0)
        colO = CStr(roundedO) & " OR " & CStr(roundedO - 1) & " (rounded from " & Cells(currentRowNum, 15).Value & ")"
    Else
        colO = CStr(Cells(currentRowNum, 15).Value)
    End If
    On Error GoTo 0
    
    ' Display results
    MsgBox "Test for Row " & currentRowNum & vbCrLf & vbCrLf & _
           "=== NAME DATA ===" & vbCrLf & _
           "Full Name (Col A): " & fullName & vbCrLf & _
           "First Name (Col B): " & firstName & vbCrLf & _
           "Name to Search: " & nameToSearch & vbCrLf & vbCrLf & _
           "=== CTS DATA ===" & vbCrLf & _
           "CTS Name (Col M): " & ctsName & vbCrLf & _
           "CTS Search Term (3 letters): " & ctsSearchTerm & vbCrLf & vbCrLf & _
           "=== ADDITIONAL FIELDS (OR) ===" & vbCrLf & _
           "Arrival (Col C): " & colC & vbCrLf & _
           "Departure (Col D): " & colD & vbCrLf & _
           "NET (Col I): " & colI & vbCrLf & _
           "TOTAL (Col J): " & colJ & vbCrLf & _
           "ADR (Col O): " & colO & vbCrLf & vbCrLf & _
           "=== SEARCH SCOPE ===" & vbCrLf & _
           "Searches: Email body, subject, attachments (filenames + content)" & vbCrLf & vbCrLf & _
           "=== FINAL QUERY (NO QUOTES) ===" & vbCrLf & _
           searchQuery, vbInformation, "Search Test"
End Sub

' Quick search for selected cell
Sub QuickCellSearch()
    ' OPTIMIZED VERSION - Uses cached connection
    Dim olApp As Object
    Dim olExplorer As Object
    Dim searchText As String
    Dim currentRowNum As Long

    ' Optimize
    Application.ScreenUpdating = False
    Application.EnableEvents = False

    currentRowNum = ActiveCell.Row
    searchText = Trim(ActiveCell.Value)

    If searchText = "" Then
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Please select a cell with text to search.", vbExclamation
        Exit Sub
    End If

    ' OPTIMIZATION: Use cached connection
    On Error Resume Next
    Set olApp = GetOutlookConnection()
    Set olExplorer = olApp.ActiveExplorer

    If olExplorer Is Nothing Then
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        Exit Sub
    End If

    ' Search in current mailbox with date filter
    searchText = searchText & " AND received:>=" & "01/01/2025"

    olExplorer.Search searchText, 4

    BringOutlookToFront olApp

    ' Mark Column R and move to next row (if not on header)
    If currentRowNum > 1 Then
        Cells(currentRowNum, 18).Value = "C"
        If currentRowNum < Rows.Count Then
            Cells(currentRowNum + 1, 18).Select
        End If
    End If

    Application.ScreenUpdating = True
    Application.EnableEvents = True
End Sub

' Clear search
Sub ClearOutlookSearch()
    ' OPTIMIZED VERSION - Uses cached connection
    Dim olApp As Object
    Dim olExplorer As Object

    On Error Resume Next
    Set olApp = GetOutlookConnection()
    If olApp Is Nothing Then
        MsgBox "Outlook is not running.", vbExclamation
        Exit Sub
    End If

    Set olExplorer = olApp.ActiveExplorer
    If Not olExplorer Is Nothing Then
        olExplorer.Search "", 1
        MsgBox "Outlook search cleared.", vbInformation
    End If
End Sub

' Fast batch search for multiple rows
Sub SearchMultipleRows()
    ' OPTIMIZED VERSION - Uses array processing for 10-20x speed improvement
    Dim olApp As Object
    Dim olExplorer As Object
    Dim startRow As Long, endRow As Long
    Dim i As Long
    Dim searchQuery As String
    Dim nameToSearch As String, ctsSearchTerm As String
    Dim additionalFields As String
    Dim dataArray As Variant
    Dim marksArray() As Variant
    Dim processedCount As Long

    ' Get range
    startRow = Selection.Row
    endRow = Selection.Row + Selection.Rows.Count - 1

    If startRow = 1 Then startRow = 2 ' Skip header

    ' Optimize for speed
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    ' OPTIMIZATION: Read all data into array once (MUCH faster)
    dataArray = Range("A1:V" & endRow).Value2

    ' OPTIMIZATION: Prepare marks array for batch write
    ReDim marksArray(1 To endRow - startRow + 1, 1 To 1)

    ' OPTIMIZATION: Use cached Outlook connection
    On Error Resume Next
    Set olApp = GetOutlookConnection()
    Set olExplorer = olApp.ActiveExplorer
    On Error GoTo 0

    If olExplorer Is Nothing Then
        Application.Calculation = xlCalculationAutomatic
        Application.ScreenUpdating = True
        Application.EnableEvents = True
        MsgBox "Cannot access Outlook.", vbCritical
        Exit Sub
    End If

    processedCount = 0

    ' Process each row from array (much faster than cell access)
    For i = startRow To endRow
        If Trim(CStr(dataArray(i, 1))) <> "" Or Trim(CStr(dataArray(i, 2))) <> "" Then
            ' Get data from array
            nameToSearch = GetSearchName(Trim(CStr(dataArray(i, 1))), Trim(CStr(dataArray(i, 2))))
            ctsSearchTerm = GetCTSSearchTerm(Trim(CStr(dataArray(i, 13))))

            ' OPTIMIZATION: Extract array values to variables (VBA compile fix)
            Dim tempArrival As Variant, tempDeparture As Variant
            Dim tempNet As Variant, tempTotal As Variant, tempAdr As Variant
            tempArrival = dataArray(i, 3)
            tempDeparture = dataArray(i, 4)
            tempNet = dataArray(i, 9)
            tempTotal = dataArray(i, 10)
            tempAdr = dataArray(i, 15)

            ' Use fast function with values
            additionalFields = GetAdditionalFieldsRoundedFast(tempArrival, tempDeparture, tempNet, tempTotal, tempAdr)

            searchQuery = BuildSearchQueryNoQuotes(nameToSearch, ctsSearchTerm, additionalFields)

            ' Perform search in current mailbox
            On Error Resume Next
            olExplorer.Search searchQuery, 4
            On Error GoTo 0

            ' Store mark in array (write later)
            marksArray(i - startRow + 1, 1) = "C"
            processedCount = processedCount + 1

            ' Brief pause between searches
            If processedCount Mod 10 = 0 Then DoEvents
        Else
            marksArray(i - startRow + 1, 1) = dataArray(i, 18) ' Keep existing value
        End If
    Next i

    ' OPTIMIZATION: Write all marks at once (much faster than individual cell writes)
    Range("R" & startRow & ":R" & endRow).Value = marksArray

    ' Restore settings
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    Application.EnableEvents = True

    BringOutlookToFront olApp

    MsgBox "Searched " & processedCount & " rows out of " & (endRow - startRow + 1) & " total rows." & vbCrLf & _
           "All rows marked in Column R.", vbInformation
End Sub

' ===== CACHE MANAGEMENT =====
' Use this if you need to reset the Outlook connection (rarely needed)
Sub ResetOutlookCache()
    ' Clears the cached Outlook connection
    ' Run this if Outlook behaves unexpectedly
    Set CachedOutlookApp = Nothing
    Set CachedOutlookExplorer = Nothing
    MsgBox "Outlook cache cleared. Next search will reconnect.", vbInformation
End Sub

' ===== ATTACHMENT SEARCH DIAGNOSTICS =====
Sub CheckAttachmentSearchStatus()
    ' Checks if Windows Search indexing is enabled for Outlook
    ' This is REQUIRED for searching inside PDF and document attachments
    Dim msg As String

    msg = "ATTACHMENT SEARCH CAPABILITY" & vbCrLf & vbCrLf & _
          "The code now searches for your terms in:" & vbCrLf & _
          "1. Email subject and body" & vbCrLf & _
          "2. Attachment filenames (always works)" & vbCrLf & _
          "3. Attachment content - PDFs, Word, Excel, etc." & vbCrLf & vbCrLf & _
          "IMPORTANT: Attachment CONTENT search requires:" & vbCrLf & _
          "- Windows Search service running" & vbCrLf & _
          "- Outlook data files indexed by Windows Search" & vbCrLf & vbCrLf & _
          "To enable attachment content search:" & vbCrLf & _
          "1. Open Windows Settings" & vbCrLf & _
          "2. Go to Privacy & Security > Searching Windows" & vbCrLf & _
          "3. Click 'Advanced indexing options'" & vbCrLf & _
          "4. Ensure Outlook is in the indexed locations" & vbCrLf & _
          "5. Click 'Advanced' > File Types tab" & vbCrLf & _
          "6. Ensure .pdf, .doc, .docx are set to 'Index Properties and File Contents'" & vbCrLf & vbCrLf & _
          "The search will work for filenames even without indexing enabled."

    MsgBox msg, vbInformation, "Attachment Search Information"
End Sub

' ===== CTS VALIDATION RULES =====
Function GetCTSValidationMessage(ctsName As String) As String
    ' Returns validation checklist message based on CTS name
    ' All rules are stored directly in code for fast access
    Dim checkMsg As String
    Dim upperCTS As String

    ' Exit if no CTS name
    If Trim(ctsName) = "" Then
        GetCTSValidationMessage = ""
        Exit Function
    End If

    upperCTS = UCase(Trim(ctsName))
    checkMsg = ""

    ' Check for matches (case insensitive, partial match)
    ' Non T- prefixed providers
    If InStr(upperCTS, "WEBBEDS") > 0 Then
        checkMsg = "1. Is VCC attached?"
    ElseIf InStr(upperCTS, "TRAVELTINO") > 0 Then
        checkMsg = "1. Is VCC attached?"
    ElseIf InStr(upperCTS, "HOLIDAY MOMENTS") > 0 Then
        checkMsg = "1. Is HB confirmed? 2. Does it match original LPO?"
    ElseIf InStr(upperCTS, "MIRACLE") > 0 Then
        checkMsg = "1. Is HB confirmed? 2. Does it match original LPO?"
    ElseIf InStr(upperCTS, "GRP") > 0 Then
        checkMsg = "1. Does total match invoice? 2. Does rate code in Column K start with GRP?"
    ElseIf InStr(upperCTS, "EXPEDIA") > 0 Then
        checkMsg = "1. Is HB rate code verified?"
    ElseIf InStr(upperCTS, "BOOKING") > 0 Then
        checkMsg = "1. Is HB rate code verified?"

    ' T- prefixed providers
    ElseIf InStr(upperCTS, "ADONIS TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "AGODA") > 0 Then
        checkMsg = "1. Is HB Rate Code verified?"
    ElseIf InStr(upperCTS, "AL KHALIDIAH") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ALL TRAVEL DUBAI") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ALMOSAFER") > 0 Then
        checkMsg = "1. Is total amount verified?"
    ElseIf InStr(upperCTS, "ANEX TOURISM") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ARABIAN ORYX") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "BTB TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "CR7 WONDERS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "DAR AL HANA") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "DARINA HOLIDAYS") > 0 Then
        checkMsg = "1. Is number of nights verified?"
    ElseIf InStr(upperCTS, "DESERT ADVENTURES") > 0 Then
        checkMsg = "1. Is rate breakdown verified? 2. Does it match original LPO?"
    ElseIf InStr(upperCTS, "DESERT GATE") > 0 Then
        checkMsg = "1. Is rate breakdown verified? 2. Does it match original LPO?"
    ElseIf InStr(upperCTS, "DURI TRAVEL") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ELEVATE TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "FCM SINGAPORE") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "FUN AND SUN") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "GULF CIRCLE") > 0 Then
        checkMsg = "1. Are comments checked? 2. Is TDF to TA verified?"
    ElseIf InStr(upperCTS, "HOLIDAYS TOURS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "HOTELBEDS") > 0 Then
        checkMsg = "1. Is booking confirmed? 2. Are payment details verified?"
    ElseIf InStr(upperCTS, "HRS HOTEL") > 0 Then
        checkMsg = "1. Is booking confirmed?"
    ElseIf InStr(upperCTS, "JOYCE TOURS") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "KALAMAKI TRAVEL") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "KALANIT TOURS") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "KURBAN TOURS") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "LAMAR HOLIDAYS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "LUXEC TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "MAHFOUZ TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "NOAH'S ARK") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ODEON TRAVEL") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ORIENTAL ROUTES") > 0 Then
        checkMsg = "1. Are comments checked?"
    ElseIf InStr(upperCTS, "PHOENIQ") > 0 Then
        checkMsg = "1. Is booking confirmed?"
    ElseIf InStr(upperCTS, "RAYNA TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "ROCKET DESTINATION") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "RUSTAR TOURISM") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "SATGURU TRAVEL") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "SHARAF TOURS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "SKYMAX HOLIDAYS") > 0 Then
        checkMsg = "1. Is invoice sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "SPLENDID TRAVEL") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "TA CONNECTIONS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    ElseIf InStr(upperCTS, "VOYAGE TOURS") > 0 Then
        checkMsg = "1. Is payment link sent? 2. Is trace there?"
    End If

    GetCTSValidationMessage = checkMsg
End Function

Sub ShowCTSValidationPopup(ctsName As String)
    ' Shows validation checklist popup based on CTS name
    Dim checkMessage As String

    ' Debug: Show what CTS name we received
    MsgBox "DEBUG: CTS Name = '" & ctsName & "'", vbInformation

    ' Get validation message for this CTS
    checkMessage = GetCTSValidationMessage(ctsName)

    ' Debug: Show what message we got
    MsgBox "DEBUG: Message = '" & checkMessage & "'", vbInformation

    ' Show popup if there's a message
    If checkMessage <> "" Then
        MsgBox "CTS: " & ctsName & vbCrLf & vbCrLf & _
               "VALIDATION CHECKLIST:" & vbCrLf & vbCrLf & _
               checkMessage, vbInformation, "CTS Validation Reminder"
    Else
        ' If no specific rule found, show generic message
        If Trim(ctsName) <> "" Then
            MsgBox "CTS: " & ctsName & vbCrLf & vbCrLf & _
                   "No specific validation rules configured for this CTS provider.", _
                   vbInformation, "CTS Validation Reminder"
        End If
    End If
End Sub

